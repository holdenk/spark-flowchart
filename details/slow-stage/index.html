<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Identify the slow stage - Spark Advanced Topics</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Spark Advanced Topics</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Spark Advanced Topics Working Group Documentation</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Details <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../best-pratice-collect/" class="dropdown-item">Bringing too much data back to the driver (collect and friends)</a>
</li>
                                    
<li>
    <a href="../big-broadcast-join/" class="dropdown-item">Too big broadcast joins</a>
</li>
                                    
<li>
    <a href="../broadcast-with-disable/" class="dropdown-item">Tables getting broadcasted even when broadcast is disabled</a>
</li>
                                    
<li>
    <a href="../class-or-method-not-found/" class="dropdown-item">Class or method not found</a>
</li>
                                    
<li>
    <a href="../container-oom/" class="dropdown-item">Container OOMs</a>
</li>
                                    
<li>
    <a href="../correlated-column-not-allowed/" class="dropdown-item">spark.sql.AnalysisException: Correlated column is not allowed in predicate</a>
</li>
                                    
<li>
    <a href="../driver-max-result-size/" class="dropdown-item">Result size larger than spark.driver.maxResultSize error OR Kryo serialization failed: Buffer overflow.</a>
</li>
                                    
<li>
    <a href="../error-driver-max-result-size/" class="dropdown-item">Result size larger than spark.driver.maxResultsSize error</a>
</li>
                                    
<li>
    <a href="../error-driver-out-of-memory/" class="dropdown-item">Driver ran out of memory</a>
</li>
                                    
<li>
    <a href="../error-driver-stack-overflow/" class="dropdown-item">Driver ran out of memory</a>
</li>
                                    
<li>
    <a href="../error-executor-out-of-disk/" class="dropdown-item">Executor out of disk error</a>
</li>
                                    
<li>
    <a href="../error-executor-out-of-memory/" class="dropdown-item">Executor ran out of memory</a>
</li>
                                    
<li>
    <a href="../error-invalid-file/" class="dropdown-item">Missing Files / File Not Found / Reading past RLE/BitPacking stream</a>
</li>
                                    
<li>
    <a href="../error-job/" class="dropdown-item">Error</a>
</li>
                                    
<li>
    <a href="../error-memory/" class="dropdown-item">Memory Errors</a>
</li>
                                    
<li>
    <a href="../error-other/" class="dropdown-item">Other errors</a>
</li>
                                    
<li>
    <a href="../error-shuffle/" class="dropdown-item">Fetch Failed exceptions</a>
</li>
                                    
<li>
    <a href="../error-sql-analysis/" class="dropdown-item">spark.sql.AnalysisException</a>
</li>
                                    
<li>
    <a href="../even_partitioning_still_slow/" class="dropdown-item">Even Partitioning Yet Still Slow</a>
</li>
                                    
<li>
    <a href="../failed-to-read-non-parquet-file/" class="dropdown-item">Failed to read non-parquet file</a>
</li>
                                    
<li>
    <a href="../failure-executor-large-record/" class="dropdown-item">Large record problems can show up in a few different ways.</a>
</li>
                                    
<li>
    <a href="../forced-computations/" class="dropdown-item">Force computations</a>
</li>
                                    
<li>
    <a href="../key-skew/" class="dropdown-item">Key/Partition Skew</a>
</li>
                                    
<li>
    <a href="../notenoughexecs/" class="dropdown-item">Notenoughexecs</a>
</li>
                                    
<li>
    <a href="../partial_aggregates/" class="dropdown-item">Partial v.s. Full Aggregates</a>
</li>
                                    
<li>
    <a href="../pyudfoom/" class="dropdown-item">PySpark UDF / UDAF OOM</a>
</li>
                                    
<li>
    <a href="../read-partition-issue/" class="dropdown-item">Partition at read time</a>
</li>
                                    
<li>
    <a href="../revise-bad_partitioning/" class="dropdown-item">Bad Partitioning</a>
</li>
                                    
<li>
    <a href="../revise-even_partitioning_still_slow/" class="dropdown-item">Even Partitioning Yet Still Slow</a>
</li>
                                    
<li>
    <a href="../slow-executor/" class="dropdown-item">Slow executor</a>
</li>
                                    
<li>
    <a href="../slow-job-slow-cluster/" class="dropdown-item">Slow job slow cluster</a>
</li>
                                    
<li>
    <a href="../slow-job/" class="dropdown-item">Slow job</a>
</li>
                                    
<li>
    <a href="../slow-map/" class="dropdown-item">Slow Map</a>
</li>
                                    
<li>
    <a href="../slow-partition_filter_pushdown/" class="dropdown-item">Partition Filters</a>
</li>
                                    
<li>
    <a href="../slow-reduce/" class="dropdown-item">Slow reduce</a>
</li>
                                    
<li>
    <a href="../slow-regex-tips/" class="dropdown-item">Regular Expression Tips</a>
</li>
                                    
<li>
    <a href="../slow-skewed-join/" class="dropdown-item">Skewed Joins</a>
</li>
                                    
<li>
    <a href="../slow-skewed-write/" class="dropdown-item">Skewed/Slow Write</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Identify the slow stage</a>
</li>
                                    
<li>
    <a href="../slow-writes-s3/" class="dropdown-item">Slow writes on S3</a>
</li>
                                    
<li>
    <a href="../slow-writes-too-many-files/" class="dropdown-item">Slow writes due to Too many small files</a>
</li>
                                    
<li>
    <a href="../slow-writes/" class="dropdown-item">Slow Writes</a>
</li>
                                    
<li>
    <a href="../toobigdag/" class="dropdown-item">Too Big DAG (or when iterative algorithms go bump in the night)</a>
</li>
                                    
<li>
    <a href="../toofew_tasks/" class="dropdown-item">Toofew tasks</a>
</li>
                                    
<li>
    <a href="../toomany_tasks/" class="dropdown-item">Toomany tasks</a>
</li>
                                    
<li>
    <a href="../udfslow/" class="dropdown-item">Avoid UDFs for the most part</a>
</li>
                                    
<li>
    <a href="../write-fails/" class="dropdown-item">Write Fails</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Flowchart <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../flowchart/" class="dropdown-item">Index</a>
</li>
                                    
<li>
    <a href="../../flowchart/error/" class="dropdown-item">Error</a>
</li>
                                    
<li>
    <a href="../../flowchart/shared/" class="dropdown-item">Shared</a>
</li>
                                    
<li>
    <a href="../../flowchart/slow/" class="dropdown-item">Slow</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../slow-skewed-write/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../slow-writes-s3/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#identify-the-slow-stage" class="nav-link">Identify the slow stage</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="identify-the-slow-stage">Identify the slow stage</h1>
<h3 id="when-you-have-an-event-log-from-an-earlier-good-run">When you have an event log from an earlier "good run"</h3>
<p>You can compare the slow and the fast runs.
For this you can even use your local pyspark and calculate a ratio between slow and fast run for each stage metrics:</p>
<pre class="highlight"><code># Helper methods (just copy-paste it)

def createEventView(eventLogFile, eventViewName):
  sql("CREATE OR REPLACE TEMPORARY VIEW {} USING org.apache.spark.sql.json OPTIONS (path '{}')".format(eventViewName, eventLogFile))


def createStageMetricsView(eventViewName, stageMetricsViewName):
  sql("CREATE OR REPLACE TEMPORARY VIEW {} AS select `Submission Time`, `Completion Time`, `Stage ID`, t3.col.* from (select `Stage Info`.* from {} where Event='SparkListenerStageCompleted') lateral view explode(Accumulables) t3".format(stageMetricsViewName, eventViewName))


def showDiffInStage(fastStagesTable, slowStagesTable, stageID):
  sql("select {fastStages}.Name, {fastStages}.Value as Fast, {slowStages}.Value as Slow, {slowStages}.Value / {fastStages}.Value as `Slow / Fast` from {fastStages} INNER JOIN {slowStages} ON {fastStages}.ID = {slowStages}.ID where {fastStages}.`Stage ID` = {stageID} and {slowStages}.`Stage ID` = {stageID}".format(fastStages=fastStagesTable, slowStages=slowStagesTable, stageID=stageID)).show(40, False)


# Creating the views from the event logs (just an example, you have to specify your own paths)

createEventView("&lt;path_to_the_fast_run_event_log&gt;", "FAST_EVENTS")
createStageMetricsView("FAST_EVENTS", "FAST_STAGE_METRICS")

createEventView("&lt;path_to_the_slow_run_event_log&gt;", "SLOW_EVENTS")
createStageMetricsView("SLOW_EVENTS", "SLOW_STAGE_METRICS")

&gt;&gt;&gt; sql("SELECT DISTINCT `Stage ID` from FAST_STAGE_METRICS").show()
+--------+
|Stage ID|
+--------+
|       0|
|       1|
|       2|
+--------+

&gt;&gt;&gt; sql("SELECT DISTINCT `Stage ID` from SLOW_STAGE_METRICS").show()
+--------+
|Stage ID|
+--------+
|       0|
|       1|
|       2|
+--------+

&gt;&gt;&gt; showDiffInStage("FAST_STAGE_METRICS", "SLOW_STAGE_METRICS", 2)
+-------------------------------------------+-------------+-------------+------------------+
|Name                                       |Fast         |Slow         |Slow / Fast       |
+-------------------------------------------+-------------+-------------+------------------+
|scan time total (min, med, max)            |1095931      |1628308      |1.485776020570638 |
|internal.metrics.executorRunTime           |7486648      |12990126     |1.735105750931525 |
|duration total (min, med, max)             |7017645      |12322243     |1.7558943206731032|
|internal.metrics.jvmGCTime                 |220325       |1084412      |4.921874503574266 |
|internal.metrics.output.bytesWritten       |34767744411  |34767744411  |1.0               |
|internal.metrics.input.recordsRead         |149652381    |149652381    |1.0               |
|internal.metrics.executorDeserializeCpuTime|5666230304   |7760682789   |1.3696377260771504|
|internal.metrics.resultSize                |625598       |626415       |1.0013059504665935|
|internal.metrics.executorCpuTime           |6403420405851|8762799691603|1.3684560963069305|
|internal.metrics.input.bytesRead           |69488204276  |69488204276  |1.0               |
|number of output rows                      |149652381    |149652381    |1.0               |
|internal.metrics.resultSerializationTime   |36           |72           |2.0               |
|internal.metrics.output.recordsWritten     |149652381    |149652381    |1.0               |
|internal.metrics.executorDeserializeTime   |6024         |11954        |1.9843957503320053|
+-------------------------------------------+-------------+-------------+------------------+</code></pre>
<h3 id="when-there-is-no-event-log-from-a-good-run">When there is no event log from a good run</h3>
<p>Steps: </p>
<ol>
<li>Navigate to Spark UI using spark history URL</li>
<li>Click on <code>Stages</code> and sort the stages(click on <code>Duration</code>) in descending order to find the longest running stage.</li>
</ol>
<p><img alt="IdentifySlowStage" src="../../imgs/identify-slow-stage.png" /></p>
<h3 id="now-lets-figure-out-if-the-slow-stage-is-a-map-or-reduceshuffle">Now let's figure out if the slow stage is a <code>Map</code> or <code>Reduce/Shuffle</code></h3>
<p>Once you identify the slow stage, check the fields "Input", "Output", "Shuffle Read", "Shuffle Write" of the slow stage and use below grid to identify the stage type and the corresponding ETL action.</p>
<pre class="highlight"><code> -----------------------------------------------------------------------------------
| Input | Output | Shuffle Read | Shuffle Write |  MR Stage  |  ETL Action          |
|------------------------------------------------------------|----------------------|
|   X   |        |              |       X       |    Map     |     Read             |
|------------------------------------------------------------|----------------------|
|   X   |    X   |              |               |    Map     |   Read/Write         |
|------------------------------------------------------------|----------------------|
|   X   |        |              |               |    Map     | Sort Estimate        |
|------------------------------------------------------------|----------------------|
|       |        |      X       |               |    Map     | Sort Estimate        |
|------------------------------------------------------------|----------------------|
|       |        |      X       |       X       |   Reduce   | Join/Agg/Repartition |
|------------------------------------------------------------|----------------------|
|       |    X   |      X       |               |   Reduce   |     Write            |
 ------------------------------------------------------------|----------------------

</code></pre>
<p>go to <a href="../slow-map">Map</a> if the slow stage is from a Map operation.
go to <a href="../slow-reduce">Reduce</a> if the slow stage is from a Reduce/Shuffle operation.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright various authors 2022-2024, CC-BY-SA 4.0</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/jquery-3.6.0.min.js"></script>
        <script src="../../js/bootstrap.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
