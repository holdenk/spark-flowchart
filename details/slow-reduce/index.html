<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Slow reduce - Spark Advanced Topics</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Spark Advanced Topics</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Spark Advanced Topics Working Group Documentation</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Details <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../best-pratice-collect/" class="dropdown-item">Bringing too much data back to the driver (collect and friends)</a>
</li>
                                    
<li>
    <a href="../big-broadcast-join/" class="dropdown-item">Too big broadcast joins</a>
</li>
                                    
<li>
    <a href="../broadcast-with-disable/" class="dropdown-item">Tables getting broadcasted even when broadcast is disabled</a>
</li>
                                    
<li>
    <a href="../class-or-method-not-found/" class="dropdown-item">Class or method not found</a>
</li>
                                    
<li>
    <a href="../container-oom/" class="dropdown-item">Container OOMs</a>
</li>
                                    
<li>
    <a href="../correlated-column-not-allowed/" class="dropdown-item">spark.sql.AnalysisException: Correlated column is not allowed in predicate</a>
</li>
                                    
<li>
    <a href="../driver-max-result-size/" class="dropdown-item">Result size larger than spark.driver.maxResultSize error OR Kryo serialization failed: Buffer overflow.</a>
</li>
                                    
<li>
    <a href="../error-driver-max-result-size/" class="dropdown-item">Result size larger than spark.driver.maxResultsSize error</a>
</li>
                                    
<li>
    <a href="../error-driver-out-of-memory/" class="dropdown-item">Driver ran out of memory</a>
</li>
                                    
<li>
    <a href="../error-driver-stack-overflow/" class="dropdown-item">Driver ran out of memory</a>
</li>
                                    
<li>
    <a href="../error-executor-out-of-disk/" class="dropdown-item">Executor out of disk error</a>
</li>
                                    
<li>
    <a href="../error-executor-out-of-memory/" class="dropdown-item">Executor ran out of memory</a>
</li>
                                    
<li>
    <a href="../error-invalid-file/" class="dropdown-item">Missing Files / File Not Found / Reading past RLE/BitPacking stream</a>
</li>
                                    
<li>
    <a href="../error-job/" class="dropdown-item">Error</a>
</li>
                                    
<li>
    <a href="../error-memory/" class="dropdown-item">Memory Errors</a>
</li>
                                    
<li>
    <a href="../error-other/" class="dropdown-item">Other errors</a>
</li>
                                    
<li>
    <a href="../error-shuffle/" class="dropdown-item">Fetch Failed exceptions</a>
</li>
                                    
<li>
    <a href="../error-sql-analysis/" class="dropdown-item">spark.sql.AnalysisException</a>
</li>
                                    
<li>
    <a href="../even_partitioning_still_slow/" class="dropdown-item">Even Partitioning Yet Still Slow</a>
</li>
                                    
<li>
    <a href="../failed-to-read-non-parquet-file/" class="dropdown-item">Failed to read non-parquet file</a>
</li>
                                    
<li>
    <a href="../failure-executor-large-record/" class="dropdown-item">Large record problems can show up in a few different ways.</a>
</li>
                                    
<li>
    <a href="../forced-computations/" class="dropdown-item">Force computations</a>
</li>
                                    
<li>
    <a href="../key-skew/" class="dropdown-item">Key/Partition Skew</a>
</li>
                                    
<li>
    <a href="../notenoughexecs/" class="dropdown-item">Notenoughexecs</a>
</li>
                                    
<li>
    <a href="../partial_aggregates/" class="dropdown-item">Partial v.s. Full Aggregates</a>
</li>
                                    
<li>
    <a href="../pyudfoom/" class="dropdown-item">PySpark UDF / UDAF OOM</a>
</li>
                                    
<li>
    <a href="../read-partition-issue/" class="dropdown-item">Partition at read time</a>
</li>
                                    
<li>
    <a href="../revise-bad_partitioning/" class="dropdown-item">Bad Partitioning</a>
</li>
                                    
<li>
    <a href="../revise-even_partitioning_still_slow/" class="dropdown-item">Even Partitioning Yet Still Slow</a>
</li>
                                    
<li>
    <a href="../slow-executor/" class="dropdown-item">Slow executor</a>
</li>
                                    
<li>
    <a href="../slow-job-slow-cluster/" class="dropdown-item">Slow job slow cluster</a>
</li>
                                    
<li>
    <a href="../slow-job/" class="dropdown-item">Slow job</a>
</li>
                                    
<li>
    <a href="../slow-map/" class="dropdown-item">Slow Map</a>
</li>
                                    
<li>
    <a href="../slow-partition_filter_pushdown/" class="dropdown-item">Partition Filters</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Slow reduce</a>
</li>
                                    
<li>
    <a href="../slow-regex-tips/" class="dropdown-item">Regular Expression Tips</a>
</li>
                                    
<li>
    <a href="../slow-skewed-join/" class="dropdown-item">Skewed Joins</a>
</li>
                                    
<li>
    <a href="../slow-skewed-write/" class="dropdown-item">Skewed/Slow Write</a>
</li>
                                    
<li>
    <a href="../slow-stage/" class="dropdown-item">Identify the slow stage</a>
</li>
                                    
<li>
    <a href="../slow-writes-s3/" class="dropdown-item">Slow writes on S3</a>
</li>
                                    
<li>
    <a href="../slow-writes-too-many-files/" class="dropdown-item">Slow writes due to Too many small files</a>
</li>
                                    
<li>
    <a href="../slow-writes/" class="dropdown-item">Slow Writes</a>
</li>
                                    
<li>
    <a href="../toobigdag/" class="dropdown-item">Too Big DAG (or when iterative algorithms go bump in the night)</a>
</li>
                                    
<li>
    <a href="../toofew_tasks/" class="dropdown-item">Toofew tasks</a>
</li>
                                    
<li>
    <a href="../toomany_tasks/" class="dropdown-item">Toomany tasks</a>
</li>
                                    
<li>
    <a href="../udfslow/" class="dropdown-item">Avoid UDFs for the most part</a>
</li>
                                    
<li>
    <a href="../write-fails/" class="dropdown-item">Write Fails</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Flowchart <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../flowchart/" class="dropdown-item">Index</a>
</li>
                                    
<li>
    <a href="../../flowchart/error/" class="dropdown-item">Error</a>
</li>
                                    
<li>
    <a href="../../flowchart/shared/" class="dropdown-item">Shared</a>
</li>
                                    
<li>
    <a href="../../flowchart/slow/" class="dropdown-item">Slow</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../slow-partition_filter_pushdown/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../slow-regex-tips/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            
            
            
            
            
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h3 id="slow-reduce">Slow Reduce</h3>
<p>Below is a list of reasons why your map stage might be slow. Note that this is not an exhaustive list but covers most of the scenarios.</p>
<ol>
<li><a href="../slow-reduce/#not-enough-shuffle-tasks">Not Enough Shuffle Tasks</a></li>
<li><a href="../slow-reduce/#too-many-shuffle-tasks">Too many shuffle tasks</a></li>
<li><a href="../slow-reduce/#skewed-shuffle-tasks">Skewed Shuffle Tasks</a></li>
<li><a href="../slow-reduce/#spill-to-disk">Spill To Disk</a></li>
</ol>
<h3 id="not-enough-shuffle-tasks">Not Enough Shuffle Tasks</h3>
<p>The default shuffle parallelism for our Spark cluster is 500, and it may not be enough for larger datasets. If you don't see skew and most/all of the tasks are taking really long to finish a <code>reduce</code> stage, you can improve the overall runtime by increasing the <code>spark.sql.shuffle.partitions</code>.</p>
<p>Note that if you are constrained by the resources(reduce tasks are just waiting for resources and not in RUNNING status), you would have to request more executors for your job by increasing <code>spark.dynamicAllocation.maxExecutors</code></p>
<h3 id="too-many-shuffle-tasks">Too many shuffle tasks</h3>
<p>While having too many shuffle tasks has no direct effect on the stage duration, it could slow the stage down if there are multiple retries during the shuffle stage due to shuffle fetch failures. Note that the higher the shuffle partitions, the more chances of running into <a href="../error-shuffle/">FetchFailure</a> exceptions.</p>
<h3 id="skewed-shuffle-tasks">Skewed Shuffle Tasks</h3>
<p>Partitioning problems are often the limitation of parallelism for most Spark jobs.</p>
<p>There are two primary types of bad partitioning, skewed partitioning (where the partitions are not equal in size/work) or even but non-ideal number partitioning (where the partitions are equal in size/work). If your tasks are taking roughly equivalent times to complete then you likely have even partitioning, and if they are taking unequal times to complete then you may have skewed or uneven partitioning.</p>
<p><a href="../key-skew/">What is skew and how to identify skew</a>. Skew is typically from one of the below stages:</p>
<ul>
<li>
<p>Join: Skew is natural in most of our data sets due to the nature of the data. Both Hash join and Sort-Merge join can run into skew issue if you have a lot of data for one or more keys on either side of the join. Check <a href="../slow-skewed-join/">Skewed Joins</a> for handling skewed joins with example.</p>
</li>
<li>
<p>Aggregation/Group By: All aggregate functions(UDAFs) using SQL/dataframes/Datasets implement partial aggregation(combiner in MR) so you would only run into a skew if you are using a non-algebraic functions like <code>distinct</code> and <code>percentiles</code> which can't be computed partially. <a href="../partial_aggregates/">Partial vs Full aggregates</a></p>
</li>
<li>
<p>Sort/Repartition/Coalesce before write: It is recommended to introduce an additional stage for <code>Sort</code> or <code>Repartition</code> or <code>Coalesce</code> before the <code>write</code> stage to write optimal no. of S3 files into your target table. Check<a href="../slow-skewed-write/">Skewed Write</a> for more details.</p>
</li>
</ul>
<h3 id="slow-aggregation">Slow Aggregation</h3>
<p>Below non-algebraic functions can slow down the <code>reduce</code> stage if you have too many values/rows for a given key.</p>
<ul>
<li>Count Distinct: Use HyperLogLog(HLL) based sketches for cardinality if you just need the approx counts for trends and don't need the exact counts. HLL can estimate with a standard error of 2%.</li>
<li>Percentiles: Use approx_percentile or t-digest sketches which would speed up the computation for a small accuracy trade-off.</li>
</ul>
<h3 id="spill-to-disk">Spill To Disk</h3>
<p>Spark executors will start using "disk" once they exceed the <code>spark memory</code> fraction of executor memory. This it self is not an issue but too much of "spill to disk" will slow down the stage/job. You can overcome this by either increasing the executor memory or tweaking the job/stage to consume less memory.(for ex: a Sort-Merge join requires a lot less memory than a Hash join)</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright various authors 2022-2024, CC-BY-SA 4.0</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/jquery-3.6.0.min.js"></script>
        <script src="../../js/bootstrap.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
